<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="manifest" href="manifest.webmanifest">
<script>if ('serviceWorker' in navigator) {navigator.serviceWorker.register('/books/sw.js');}</script>
<meta name="robots" content="noindex, nofollow">

<title>Autoren</title>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

<style>
:root { --panel-min-width: 300px; --panel-max-ratio: 0.8; }
body, h1, .column-options, .topbar {
  background-color: #FCFCFC; /* Light Mode Standard */
  color: #000; /* Text schwarz im Light Mode */
  font-family:'Open Sans', sans-serif;
  margin:0; padding:0;
  transition: background-color .3s, color .3s;
}
body.dark, body.dark h1, body.dark .column-options, body.dark .topbar {
  background-color: #212330; /* Dark Mode */
  color: #fff; /* Text weiß im Dark Mode */
}

h1 { font-size:2.2rem; font-weight:700; display:flex; align-items:center; gap:15px; margin:16px 20px; }
h1 a { font-size:1.6rem; margin-left:10px; text-decoration:none; color:inherit; }

#darkModeButton {
  margin-left:auto;
  border:none;
  background:none;      /* kein Hintergrund */
  cursor:pointer;
  padding:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:inherit;        /* Symbolfarbe wie Text */
  position:absolute;     /* oben rechts */
  top:16px;
  right:20px;
  z-index:1001;
}
#darkModeButton svg { display:block; }
#darkModeButton {
  margin-left:auto;
  border:none;
  background:none;
  cursor:pointer;
  padding:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:inherit;
}
#darkModeButton svg {
  width: 24px;      /* feste Breite */
  height: 24px;     /* feste Höhe */
  stroke-width: 2;  /* ggf. einheitlicher Strich */
}

/* Dark Mode Anpassung */
body.dark #darkModeButton {
  background:none;      /* kein Hintergrund im Dark Mode */
  color:#fff;        /* helles Symbol */
}

table { width:calc(100% - 40px); margin:0 20px 20px; border-collapse:collapse; table-layout:auto; }
th, td { text-align:left; padding:6px; vertical-align: middle; word-break: break-word; white-space: normal; min-width:35px; }
.list-cover { width:40px; height:60px; object-fit:cover; margin-right:8px; vertical-align:middle; display:inline-block; }
.author-link { color:black; text-decoration:none; cursor:pointer; display:block; transition:text-decoration .2s; }
.author-link:hover { text-decoration:underline; }

.detail-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index:1000; }
.detail-panel { background:#fff; width:40%; max-width:900px; min-width:var(--panel-min-width); height:100vh; box-sizing:border-box; overflow-y:auto; box-shadow:-3px 0 8px rgba(0,0,0,0.2); padding:20px; position:fixed; right:0; top:0; transition:all .2s ease; }
.resize-handle { position:absolute; left:-6px; top:0; width:12px; height:100%; cursor:ew-resize; z-index:1500; }
#closeDetail { position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; }

.book-title { font-size:1.5rem; font-weight:700; margin-bottom:0.3rem; text-align:center; }
.author-name { font-size:2rem; font-weight:bold; text-align:center; margin-bottom:15px; }
.details-container { display:flex; gap:20px; margin-top:10px; }
.details-left { flex:1; }
.details-right { flex-shrink:0; display:flex; align-items:flex-start; justify-content:center; }
.book-description { margin-top:0.8rem; line-height:1.5; text-align:justify; background: rgba(0,0,0,0.04); padding:10px; border-radius:6px; }
.author-image { width:100%; height:auto; display:block; margin-bottom:15px; box-shadow:0 0 5px rgba(0,0,0,0.3); }

td[data-label="Name"] { font-weight: bold; }

/* === TOPBAR: Suche + Info rechtsbündig === */
.topbar {
  display: flex !important;
  justify-content: flex-end !important;
  align-items: center;
  gap: 10px;
  margin: 0 20px 10px;
  box-sizing: border-box;
}
.topbar .dataTables_filter { margin:0; padding:0; }
.topbar .dataTables_filter label { display:flex; align-items:center; gap:6px; margin:0; white-space:nowrap; }
.topbar .dataTables_info { margin:0 0 0 8px; white-space:nowrap; padding:0; }
.topbar .dataTables_filter input { max-width:260px; width:auto; }

@media(max-width:1000px){ th, td { min-width:30px; } .detail-panel { width:48%; } }
@media(max-width:700px){
  td[data-label="Bücher"] { flex-direction: column !important; align-items: flex-start; }
  td::before { display:none; }
  td[data-label="Bücher"] img.list-cover, td[data-label="Bücher"] img { margin-bottom:4px; margin-right:0; }
  th, td { min-width:25px; font-size:0.95rem; }
  .detail-panel { width:100%; min-width:100%; max-width:100%; right:0; }
  .details-container { flex-direction:column; }
  table, thead, tbody, th, td, tr { display:block; }
  thead tr { display:none; }
  tbody tr { margin-bottom:15px; border-bottom:none; padding-bottom:8px; }
  td { display:flex; flex-direction:row; align-items:flex-start; gap:0.5rem; padding-left:0.5rem; padding-top:0.5rem; position:relative; text-align:left; border:none !important; }
  td::before { content: attr(data-label); flex:0 0 35%; font-weight:bold; white-space:normal; word-wrap:break-word; border:none !important; }
  td img.list-cover { flex:0 0 auto; width:90px; height:auto; max-height:150px; object-fit:cover; }
  td > * { flex:1; }
}

/* === Tabellenhintergrund inkl. Überschriften === */
#authorTable_wrapper, #authorTable, #authorTable th, #authorTable td {
  background-color: #EAEDFC; /* Light Mode */
  color: #000;
  transition: background-color .3s, color .3s;
}

#authorTable.dataTable tbody td {
  border-bottom: 3px solid #777 !important;
}

body.dark #authorTable.dataTable tbody td {
  border-bottom: 3px solid #333 !important;
}

body.dark #authorTable_wrapper, body.dark #authorTable, body.dark #authorTable th, body.dark #authorTable td {
  background-color: #171A23; /* Dark Mode */
  color: #fff;
}
/* DataTables verhindert sonst Dark-Mode-Linien */
#authorTable.dataTable.stripe tbody tr.odd > td,
#authorTable.dataTable.display tbody tr.odd > td {
  background-color: transparent !important;
}
body.dark #authorTable.dataTable.stripe tbody tr.odd > td,
body.dark #authorTable.dataTable.display tbody tr.odd > td {
  background-color: transparent !important;
}

/* === DARK MODE - Detail Overlay und Links === */
body.dark { background-color:#212330; }
body.dark #darkModeButton { background:none; color:#fff; }
body.dark .detail-panel { background:#1e1e1e; color:#e0e0e0; }
body.dark .book-description, body.dark .author-books a.book-link-detail { background: rgba(255,255,255,0.04); }
body.dark .author-link { color:white; }

/* === AUTHOR BOOK LINKS === */
.author-books { margin-top:1rem; }
.author-books a.book-link-detail { display:block; font-weight:bold; text-decoration:none; margin-bottom:0.5rem; color:black; transition:text-decoration .2s,color .2s; }
body.dark .author-books a.book-link-detail { color:white; }
.author-books a.book-link-detail:hover { text-decoration:underline; }

@media(max-width:700px){
  #authorTable.dataTable tbody td {
    border-bottom: 2px solid #777 !important;
  }
  body.dark #authorTable.dataTable tbody td {
    border-bottom: 2px solid #333 !important;
  }
}
</style>

</head>

<body>
<h1>Autoren
<a href="index.html">Bücher</a>
<a href="series.html">Reihen</a>
</h1>

<button id="darkModeButton"></button>
<table id="authorTable" class="display"></table>

<div id="detailOverlay" class="detail-overlay">
  <div id="detailPanel" class="detail-panel">
    <div class="resize-handle" title="Breite anpassen"></div>
    <span id="closeDetail">&times;</span>
    <div id="detailContent"></div>
  </div>
</div>

<script>
const DARK_KEY="app_dark_mode_v1", PANEL_WIDTH_KEY="author_panel_width_v1";
let darkMode=localStorage.getItem(DARK_KEY)==="true";
const detailPanel=document.getElementById("detailPanel");
const savedWidth=localStorage.getItem(PANEL_WIDTH_KEY);
if(savedWidth) detailPanel.style.width=savedWidth+"px";

let booksMap={}, authorData=[];

applyMode();

Promise.all([
  fetch('https://raw.githubusercontent.com/paulsgh24/books/main/json/books.json').then(r=>r.json()),
  fetch('https://raw.githubusercontent.com/paulsgh24/books/main/json/authors.json').then(r=>r.json())])
.then(([books,authors])=>{
  authorData=authors||[];
  books.forEach(b=>booksMap[b.b_id]=b);
  initTable(authors||[]);
}).catch(console.error);

function escapeHtml(str){ if(!str) return ""; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function encodeNameForFile(name){ if(!name) return ""; return encodeURIComponent(String(name)); }

function initTable(data){
  const columns=[
    { title:"Name", data:"a_fullname", render:(d,type,row)=>{
        if(type==="display"){
          const img=`<img class="list-cover" src="img/author/${encodeNameForFile(row.a_fullname)}.jpg" onerror="this.remove()" alt="Autor">`;
          return `<div style="display:flex; align-items:center; gap:8px;">${img}<span>${escapeHtml(row.a_fullname)}</span></div>`;
        }
        return d;
    }},
    { title:"Bücher", data:null, render:d=>{
        if(!d.a_bookids) return "";
        return d.a_bookids.split(",").map(id=>{
          const b=booksMap[id.trim()]; if(!b) return "";
          return `<div class="book-title-text" data-id="${id.trim()}" style="display:block;">
                    <img src="img/symbol/${b.b_typ}.png" style="width:22px;height:22px;margin-right:6px;vertical-align:middle;">
                    <span>${escapeHtml(b.b_titel)}</span>
                  </div>`;
        }).join("");
    }, orderable:false}
  ];
  columns.forEach(col=>col.createdCell=(td,cellData,rowData,row,colIdx)=>{ td.setAttribute('data-label',col.title); });

  if($.fn.DataTable.isDataTable("#authorTable")){ $("#authorTable").DataTable().clear().destroy(); $("#authorTable").empty(); }
  const table=new DataTable("#authorTable",{ data, columns, order:[[0,"asc"]], paging:false, autoWidth:false, dom:"<'topbar'fi>rt", language:{url:"https://cdn.datatables.net/plug-ins/2.0.8/i18n/de-DE.json"} });

  $("#authorTable tbody").on("click",".book-title-text",function(e){ e.preventDefault(); e.stopPropagation(); const id=$(this).data("id"); if(booksMap[id]) showBookDetail(booksMap[id]); });
  $("#authorTable tbody").on("click","tr",function(){ const author=table.row(this).data(); if(author) showAuthorDetail(author); });
  window.addEventListener("resize",()=>{ try{ table.columns.adjust();}catch{} });
}

function showBookDetail(book){
  const detailContent=document.getElementById("detailContent");
  detailContent.innerHTML="";
  document.getElementById("darkModeButton").style.display="none";

  if(book.b_titel && book.b_author){
    const img=document.createElement("img");
    const fileName=`${encodeNameForFile(book.b_titel)}_${encodeNameForFile(book.b_author)}_${encodeNameForFile(book.b_typ)}.jpg`;
    img.src=`img/book/${fileName}`;
    img.alt="Cover"; img.style.width="100%"; img.onerror=()=>img.remove();
    detailContent.appendChild(img);
  }

  const titleDiv=document.createElement("div"); titleDiv.className="book-title"; titleDiv.textContent=book.b_titel||""; detailContent.appendChild(titleDiv);

  const authorsDiv=document.createElement("div"); authorsDiv.className="author";
  if(book.b_author_id) authorsDiv.innerHTML=book.b_author_id.split(",").map(id=>{
    const a=authorData.find(x=>String(x.a_id).trim()===id.trim());
    return a?`<span class="author-link" data-id="${escapeHtml(a.a_id)}">${escapeHtml(a.a_fullname)}</span>`:"";
  }).join("");
  detailContent.appendChild(authorsDiv);

  const container=document.createElement("div"); container.className="details-container";
  const leftDiv=document.createElement("div"); leftDiv.className="details-left";
  const rightDiv=document.createElement("div"); rightDiv.className="details-right";
  const fields={Reihe:book.b_series, Nummer:book.b_series_no, Jahr:book.b_year, Länge:book.b_length, Genres:book.b_genres, Sprecher:book.b_narrator};
  for(const key in fields){ if(fields[key] && String(fields[key]).trim()!==""){ const div=document.createElement("div"); div.innerHTML=`<strong>${key}:</strong> ${escapeHtml(fields[key])}`; leftDiv.appendChild(div); } }
  if(book.b_typ){ const img=document.createElement("img"); img.src="img/symbol/"+encodeURIComponent(String(book.b_typ).toLowerCase())+".png"; img.width=72; img.height=72; rightDiv.appendChild(img); }
  container.appendChild(leftDiv); container.appendChild(rightDiv); detailContent.appendChild(container);

  if(book.b_description && book.b_description.trim()!==""){ const desc=document.createElement("div"); desc.className="book-description"; desc.textContent=book.b_description; detailContent.appendChild(desc); }
  document.getElementById("detailOverlay").style.display="block";

  authorsDiv.querySelectorAll(".author-link").forEach(el=>el.addEventListener("click",e=>{ e.stopPropagation(); const authorId=el.getAttribute("data-id"); const author=authorData.find(a=>String(a.a_id)===String(authorId)); if(author) showAuthorDetail(author); }));
}

function showAuthorDetail(author){
  const detailContent=document.getElementById("detailContent"); detailContent.innerHTML=""; document.getElementById("darkModeButton").style.display="none";
  if(author.a_fullname){ const img=document.createElement("img"); img.src=`img/author/${encodeNameForFile(author.a_fullname)}.jpg`; img.alt="Autor"; img.className="author-image"; img.onerror=()=>img.remove(); detailContent.appendChild(img); }
  const nameDiv=document.createElement("div"); nameDiv.className="author-name"; nameDiv.textContent=author.a_fullname||""; detailContent.appendChild(nameDiv);

  const authorBooks=Object.values(booksMap).filter(book=>book.b_author_id && book.b_author_id.split(",").map(z=>z.trim()).includes(String(author.a_id)));
  if(authorBooks.length){ const booksDiv=document.createElement("div"); booksDiv.className="author-books";
    authorBooks.forEach(book=>{
      const link=document.createElement("a");
      link.href="#";
      link.className="book-link-detail";
      link.addEventListener("click", e=>{
        e.preventDefault();
        showBookDetail(book);
      });

      // Typ-Symbol erstellen
      const img=document.createElement("img");
      img.src=`img/symbol/${encodeURIComponent(book.b_typ)}.png`;
      img.width=22; img.height=22;
      img.style.marginRight="6px";
      img.style.verticalAlign="middle";
      img.onerror=()=>img.remove();

      // Text erstellen
      const span=document.createElement("span");
      span.textContent=book.b_titel;

      // Icon + Titel in Link einfügen
      link.appendChild(img);
      link.appendChild(span);

      booksDiv.appendChild(link);
    });
    detailContent.appendChild(booksDiv);
  }

  if(author.a_biografie && author.a_biografie.trim()!==""){ const bio=document.createElement("div"); bio.className="book-description"; bio.textContent=author.a_biografie; detailContent.appendChild(bio); }

  document.getElementById("detailOverlay").style.display="block";
}

document.getElementById("closeDetail").addEventListener("click",()=>{ document.getElementById("detailOverlay").style.display="none"; document.getElementById("darkModeButton").style.display="block"; });
document.getElementById("detailOverlay").addEventListener("click",e=>{ if(e.target===document.getElementById("detailOverlay")){ document.getElementById("detailOverlay").style.display="none"; document.getElementById("darkModeButton").style.display="block"; } });
document.getElementById("darkModeButton").addEventListener("click",()=>{ darkMode=!darkMode; localStorage.setItem(DARK_KEY,darkMode); applyMode(); });

function applyMode(){
  document.body.classList.toggle("dark",darkMode);
  const btn=document.getElementById("darkModeButton");
  btn.innerHTML=darkMode
    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/></svg>`;}

(function enablePanelResize(){
  const panel=document.getElementById("detailPanel");
  const handle=panel.querySelector(".resize-handle");
  let startX,startWidth;
  handle.addEventListener("mousedown",e=>{
    startX=e.clientX; startWidth=panel.offsetWidth;
    document.documentElement.addEventListener("mousemove",onMouseMove);
    document.documentElement.addEventListener("mouseup",onMouseUp);
  });
  function onMouseMove(e){ let w=startWidth-(e.clientX-startX); const maxW=window.innerWidth*0.8; if(w<300) w=300; if(w>maxW) w=maxW; panel.style.width=w+"px"; }
  function onMouseUp(){ localStorage.setItem(PANEL_WIDTH_KEY,panel.offsetWidth); document.documentElement.removeEventListener("mousemove",onMouseMove); document.documentElement.removeEventListener("mouseup",onMouseUp); }
})();
</script>
</body>
</html>
